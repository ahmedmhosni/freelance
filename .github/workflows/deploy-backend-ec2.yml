name: Deploy Backend to EC2

on:
  push:
    branches:
      - kiro
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: kiro
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd backend
          npm install --production
      
      - name: Deploy to EC2
        env:
          EC2_HOST: 3.77.235.145
          EC2_USER: ubuntu
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
          
          # Deploy via SSH
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            
            # Navigate to app directory
            cd /home/ubuntu
            
            # Clone or update repository
            if [ -d "roastify" ]; then
              echo "Updating existing repository..."
              cd roastify
              git fetch origin
              git checkout kiro
              git pull origin kiro
            else
              echo "Cloning repository..."
              git clone -b kiro https://github.com/ahmedmhosni/freelance.git roastify
              cd roastify
            fi
            
            # Navigate to backend
            cd backend
            
            # Install dependencies
            echo "Installing dependencies..."
            npm install --production
            
            # Stop existing process
            echo "Restarting backend..."
            pm2 stop roastify-backend || true
            pm2 delete roastify-backend || true
            
            # Start with PM2
            pm2 start src/server.js --name roastify-backend
            pm2 save
            
            # Show status
            pm2 list
            
            echo ""
            echo "Deployment complete!"
          ENDSSH
          
          # Clean up
          rm ~/.ssh/deploy_key
      
      - name: Health Check
        run: |
          echo "Waiting for backend to start..."
          sleep 10
          
          # Test health endpoint
          curl -f http://3.77.235.145:5000/health || echo "Health check failed (backend may need more time)"
      
      - name: Deployment Summary
        run: |
          echo "========================================="
          echo "  Deployment Complete!"
          echo "========================================="
          echo ""
          echo "Backend URL: http://3.77.235.145:5000"
          echo "Frontend URL: http://roastify-frontend-prod-2024.s3-website-us-east-1.amazonaws.com"
          echo ""
